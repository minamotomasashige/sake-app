<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ak æ—¥æœ¬é…’ãƒ­ã‚° å®Œå…¨ç‰ˆ</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<style>
    :root {
        --primary: #2c3e50;
        --accent: #c9a66b;
        --bg: #f2f2f2;
        --wood: #8b5a2b;
        --wood-dark: #5e3b1f;
    }
    body {
        font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
        background-color: var(--bg);
        color: #333;
        margin: 0; padding: 0;
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: transparent;
    }

    /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ --- */
    #homePage {
        min-height: 100vh;
        display: flex; flex-direction: column; justify-content: center;
        padding: 20px; box-sizing: border-box;
    }
    #homePage.hidden { display: none !important; }
    
    h1 { text-align: center; color: var(--primary); font-size: 28px; letter-spacing: 4px; margin-bottom: 40px; }

    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .menu-card {
        background: white; border-radius: 15px; padding: 25px 10px;
        text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .menu-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
    .menu-icon { font-size: 30px; margin-bottom: 5px; color: var(--primary); }

    .ak-shelf-btn {
        grid-column: span 2;
        background: linear-gradient(to bottom, var(--wood), var(--wood-dark));
        color: white; padding: 25px; border-radius: 12px; text-align: center;
        margin-top: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        border: 2px solid #3e2714; cursor: pointer;
    }

    /* --- å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .header {
        background: var(--primary);
        color: white; padding: 15px 20px;
        position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
    }
    .back-btn { cursor: pointer; background: rgba(255,255,255,0.2); padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; }
    .page { display: none; min-height: 100vh; padding-bottom: 50px; }
    .page.active { display: block; }
    .container { padding: 20px; max-width: 600px; margin: 0 auto; }

    /* --- ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ --- */
    .form-group { background: white; padding: 20px; border-radius: 12px;
        margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .form-label { display: block; font-weight: bold; margin-bottom: 10px;
        border-left: 4px solid var(--accent); padding-left: 10px; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 12px;
        border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; font-family: sans-serif; background: #fafafa;
    }
    .tag-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag-btn { border: 1px solid #ccc; background: white; padding: 6px 12px; border-radius: 20px; font-size: 12px;
        cursor: pointer; transition: 0.2s; }
    .tag-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
    .save-btn { background: var(--primary); color: white; width: 100%; padding: 18px; border: none; border-radius: 35px; font-size: 18px;
        font-weight: bold; margin-top: 10px; cursor: pointer; }

    /* --- ãƒªã‚¹ãƒˆè¡¨ç¤º (æ¤œç´¢ç”¨) --- */
    .item-card {
        background: white;
        border-radius: 12px; padding: 12px; margin-bottom: 12px;
        display: flex; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer;
        position: relative;
        align-items: center;
    }
    .item-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; flex-shrink: 0; }
    .item-info { flex-grow: 1; overflow: hidden; }
    .item-info h3 { margin: 0 0 5px 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-info p { margin: 0; font-size: 12px; color: #666; }

    /* --- ã‚·ã‚§ãƒ«ãƒ•ãƒ»ã‚°ãƒªãƒƒãƒ‰ (æ¨ª5åˆ—è¡¨ç¤º / å†™çœŸãƒ¡ã‚¤ãƒ³) --- */
    .shelf-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        padding: 10px 0 20px 0;
    }
    .shelf-bottle {
        display: flex; flex-direction: column; align-items: center;
        position: relative; cursor: pointer;
    }
    .shelf-bottle img {
        width: 100%;
        aspect-ratio: 1; object-fit: cover; border-radius: 6px;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
    }
    .bottle-name {
        background: rgba(255,255,255,0.95); color: #222; font-size: 10px;
        font-weight: bold;
        padding: 3px 2px; border-radius: 4px; margin-top: -8px; z-index: 2;
        width: 95%; text-align: center; white-space: nowrap; overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2); border: 1px solid #eee; box-sizing: border-box;
    }
    .shelf-no {
        position: absolute; top: -6px; right: -6px;
        background: var(--accent); color: white;
        font-size: 9px; font-weight: bold; padding: 2px 5px; border-radius: 10px; z-index: 3;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }

    /* --- å…¨å›½ãƒªã‚¹ãƒˆè¦‹å‡ºã— --- */
    .list-pref-header { margin: 25px 0 10px 0;
        border-bottom: 2px solid var(--accent); padding-bottom: 5px; color: var(--primary); font-size: 18px;
    }
    .list-brew-header { margin: 15px 0 5px 0; color: #555; font-size: 14px; display: flex; align-items: center;
        gap: 5px; }

    /* --- æ¤œç´¢ãƒ»ä¸¦ã³æ›¿ãˆ --- */
    .filter-area { background: white; padding: 15px;
        margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .sort-buttons { display: flex; gap: 8px;
        margin-top: 10px; overflow-x: auto; padding-bottom: 5px; white-space: nowrap; }
    .sort-btn { padding: 6px 12px; font-size: 12px;
        border-radius: 15px; border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; }
    .sort-btn.active { background: var(--accent); color: white;
        border-color: var(--accent); font-weight: bold; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    .modal { position: fixed;
        top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; overflow-y: auto; display: none;
    }
    .modal.active { display: block; }
    .modal-img { width: 100%; height: 350px; object-fit: cover;
        background: #000; }
    .modal-body { padding: 25px; margin-top: -30px; background: white; border-radius: 25px 25px 0 0;
        position: relative; z-index: 10; min-height: 50vh; }

    #loading { position: fixed; top: 0; left: 0; width: 100%;
        height: 100%; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary);
    }
</style>
</head>
<body>

<div id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="homePage">
    <h1>ak æ—¥æœ¬é…’ãƒ­ã‚°</h1>
    <div class="menu-grid">
        <div class="menu-card" onclick="openEditPage('sake')"><div class="menu-icon"><i class="fas fa-wine-bottle"></i></div><div class="menu-title">æ—¥æœ¬é…’ã‚’è¿½åŠ </div></div>
        <div class="menu-card" onclick="showBreweryList()"><div class="menu-icon"><i class="fas fa-house-chimney"></i></div><div class="menu-title">è¨ªã‚ŒãŸè”µ</div></div>
        <div class="menu-card" onclick="openSearchPage()"><div class="menu-icon"><i class="fas fa-magnifying-glass"></i></div><div class="menu-title">æ—¥æœ¬é…’æ¤œç´¢</div></div>
        <div class="menu-card" onclick="openNationalListPage()"><div class="menu-icon"><i class="fas fa-map-location-dot"></i></div><div class="menu-title">å…¨å›½ãƒªã‚¹ãƒˆ</div></div>
        <div class="ak-shelf-btn" onclick="openShelfPage()">
            <div style="font-size: 18px; font-weight: bold; letter-spacing: 2px;"><i class="fas fa-layer-group"></i> AKæ—¥æœ¬é…’æ£š</div>
            <div style="font-size: 11px; margin-top: 5px;
            opacity: 0.9;">No.1-50 é™å®šé…’ / 51-100 å®šç•ªé…’</div>
        </div>
    </div>
    <div style="text-align:center;
    margin-top:40px;">
        <span style="font-size:12px; color:#999; text-decoration:underline;
        cursor:pointer;" onclick="exportData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
        <span style="font-size:12px; color:#999; text-decoration:underline; cursor:pointer;
        margin-left:20px;" onclick="importData()">å¾©å…ƒ(èª­ã¿è¾¼ã¿)</span>
    </div>
</div>

<div id="editSakePage" class="page">
    <div class="header"><div class="back-btn" onclick="goHome()">â—€ ãƒ›ãƒ¼ãƒ </div><span style="margin-left:auto;
    font-weight:bold;">æ—¥æœ¬é…’ã®è¨˜éŒ²</span></div>
    <div class="container">
        <div class="form-group" onclick="document.getElementById('fileSake').click()" style="text-align:center;
        cursor:pointer;">
            <div id="sakeImgPlaceholder" style="padding: 20px 0;"><i class="fas fa-camera" style="font-size:40px;
            color:#ccc;"></i><p style="color:#888; font-size:14px;">å†™çœŸã‚’æ’®ã‚‹ãƒ»é¸ã¶</p></div>
            <img id="sakeImgPreview" style="display:none; width:100%; max-height: 400px;
            object-fit:contain; border-radius:10px;">
            <input type="file" id="fileSake" hidden accept="image/*" onchange="previewImage(this, 'sakeImgPreview', 'sakeImgPlaceholder')">
        </div>
        <div class="form-group">
            <label class="form-label">éŠ˜æŸ„åï¼ˆå¿…é ˆï¼‰</label>
            <input type="text" id="sakeName" placeholder="ä¾‹ï¼šå—éƒ¨ç¾äºº">
            <label class="form-label">ç‰¹å®šåç§°ï¼ˆãƒ©ãƒ³ã‚¯ï¼‰</label>
            <select id="sakeRank">
                <option value="">é¸æŠãªã—</option>
                <option value="ç´”ç±³å¤§åŸé†¸">ç´”ç±³å¤§åŸé†¸</option><option value="ç´”ç±³åŸé†¸">ç´”ç±³åŸé†¸</option>
                <option value="ç‰¹åˆ¥ç´”ç±³">ç‰¹åˆ¥ç´”ç±³</option><option value="ç´”ç±³">ç´”ç±³</option>
                <option value="å¤§åŸé†¸">å¤§åŸé†¸</option><option value="åŸé†¸">åŸé†¸</option>
                <option value="æœ¬é†¸é€ ">æœ¬é†¸é€ </option><option value="æ™®é€šé…’">æ™®é€šé…’</option>
            </select>
            <label class="form-label">è”µå…ƒãƒ»éƒ½é“åºœçœŒ</label>
            <input type="text" id="sakeBrewery" placeholder="ä¾‹ï¼šå—éƒ¨ç¾äºº (è”µã®åå‰ã¨åˆã‚ã›ã‚‹ã¨ç¹‹ãŒã‚Šã¾ã™)">
            <input type="text" id="sakePref" placeholder="ä¾‹ï¼šå²©æ‰‹çœŒ">
        </div>
        <div class="form-group">
            <label class="form-label">AKæ£š ç•ªå· (1-100)</label>
            <input type="number" id="sakeShelfNo" placeholder="ç•ªå·ãŒãªã„å ´åˆã¯ç©ºæ¬„">
        </div>
        <div class="form-group">
            <label class="form-label">ç”˜è¾›åº¦ (å·¦:ç”˜ -5 ã€œ å³:è¾› +5)</label>
            <div style="text-align:center;
            font-size:24px; font-weight:bold; color:var(--accent);" id="degDisp">0</div>
            <input type="range" id="sakeDegree" min="-5" max="5" step="0.5" value="0" oninput="updateDegreeDisplay(this.value)">
            <div style="display:flex;
            justify-content:space-between; font-size:11px; color:#888;"><span>å¤§ç”˜å£</span><span>ä¸­å£</span><span>å¤§è¾›å£</span></div>
        </div>
        <div class="form-group">
            <label class="form-label">ç‰¹å¾´ã‚¿ã‚°</label>
            <div class="tag-grid" id="tagList"></div>
            <input type="text" id="sakeCustomTag" placeholder="è‡ªç”±å…¥åŠ›ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="margin-top:10px;">
        </div>
        <div class="form-group">
            <label class="form-label">å‘³ã‚ã„ (1-6)</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; text-align:center;
            font-size:12px;">
                <div>é¦™ã‚Š<br><input type="number" id="p1" value="3" min="1" max="6"></div>
                <div>ã‚­ãƒ¬<br><input type="number" id="p2" value="3" min="1" max="6"></div>
                <div>ã‚³ã‚¯<br><input type="number" id="p3" value="3" min="1" max="6"></div>
                <div>é…¸å‘³<br><input type="number" id="p4" value="3" min="1" max="6"></div>
                <div>ç‚­é…¸<br><input type="number" id="p5" value="1" min="1" max="6"></div>
                <div>ç”˜å‘³<br><input type="number" id="p6" value="3" min="1" max="6"></div>
            </div>
        </div>
        <div class="form-group"><label class="form-label">ãƒ¡ãƒ¢</label><textarea id="sakeMemo" rows="4" placeholder="æ„Ÿæƒ³ãªã©ã‚’è‡ªç”±ã«..."></textarea></div>
        <button class="save-btn" onclick="saveSake()">ä¿å­˜ã™ã‚‹</button>
    </div>
</div>

<div id="editBreweryPage" class="page">
    <div class="header"><div class="back-btn" onclick="showBreweryList()">â—€ è”µãƒªã‚¹ãƒˆã¸</div><span style="margin-left:auto;
    font-weight:bold;">è”µã®ç™»éŒ²</span></div>
    <div class="container">
        <div class="form-group" onclick="document.getElementById('fileBrewery').click()" style="text-align:center;
        cursor:pointer;">
            <div id="brewImgPlaceholder" style="padding: 20px 0;"><i class="fas fa-house-chimney" style="font-size:40px;
            color:#ccc;"></i><p style="color:#888; font-size:14px;">è”µã®å†™çœŸã‚’ç™»éŒ²</p></div>
            <img id="brewImgPreview" style="display:none; width:100%; max-height: 400px;
            object-fit:contain; border-radius:10px;">
            <input type="file" id="fileBrewery" hidden accept="image/*" onchange="previewImage(this, 'brewImgPreview', 'brewImgPlaceholder')">
        </div>
        <div class="form-group">
            <label class="form-label">è”µåï¼ˆå¿…é ˆï¼‰</label>
            <input type="text" id="brewName" placeholder="ä¾‹ï¼šå—éƒ¨ç¾äºº">
            <label class="form-label">å ´æ‰€</label>
            <input type="text" id="brewLoc" placeholder="ä¾‹ï¼šå²©æ‰‹çœŒäºŒæˆ¸å¸‚...">
            <label class="form-label">å…¬å¼ã‚µã‚¤ãƒˆ/SNS URL</label>
            <input type="text" id="brewUrl" placeholder="https://...">
        </div>
        <div class="form-group">
            <label class="form-label">è”µã®æ„Ÿæƒ³ãƒ»æ€ã„å‡º</label>
            <textarea id="brewMemo" rows="5"></textarea>
        </div>
        <button class="save-btn" onclick="saveBrewery()">è”µæƒ…å ±ã‚’ä¿å­˜</button>
    </div>
</div>

<div id="searchPage" class="page">
    <div class="header"><div class="back-btn" onclick="goHome()">â—€ ãƒ›ãƒ¼ãƒ </div><span style="margin-left:auto;
    font-weight:bold;">æ—¥æœ¬é…’æ¤œç´¢</span></div>
    <div class="container">
        <div class="filter-area">
            <input type="text" id="searchInput" placeholder="éŠ˜æŸ„ãƒ»è”µãƒ»ã‚¿ã‚°ã§æ¤œç´¢..." oninput="renderSakeSearch()" style="margin-bottom:0;">
            <div class="sort-buttons">
                <div class="sort-btn active" onclick="setSort('new')">æ–°ã—ã„é †</div>
                <div class="sort-btn" onclick="setSort('sweet')">ç”˜ã„é †(ï¼)</div>
                <div class="sort-btn" onclick="setSort('dry')">è¾›ã„é †(ï¼‹)</div>
            </div>
        </div>
        <div id="sakeSearchContainer"></div>
    </div>
</div>

<div id="nationalListPage" class="page">
    <div class="header"><div class="back-btn" onclick="goHome()">â—€ ãƒ›ãƒ¼ãƒ </div><span style="margin-left:auto;
    font-weight:bold;">å…¨å›½ãƒªã‚¹ãƒˆ</span></div>
    <div class="container" id="nationalListContainer">
        </div>
</div>

<div id="shelfPage" class="page" style="background: var(--bg);">
    <div class="header" style="background: var(--wood-dark);"><div class="back-btn" onclick="goHome()">â—€ ãƒ›ãƒ¼ãƒ </div><span style="margin-left:auto;
    font-weight:bold; color:#ffce44;">AKæ—¥æœ¬é…’æ£š</span></div>
    <div class="container">
        <h3 style="color:var(--wood-dark);
        border-bottom:2px solid var(--accent);">ğŸ‘‘ é™å®šé…’ (No.1 - 50)</h3>
        <div id="shelfLimited"></div>
        <h3 style="color:var(--wood-dark);
        border-bottom:2px solid var(--accent); margin-top:30px;">ğŸ¶ å®šç•ªé…’ (No.51 - 100)</h3>
        <div id="shelfStandard"></div>
    </div>
</div>

<div id="breweryListPage" class="page">
    <div class="header"><div class="back-btn" onclick="goHome()">â—€ ãƒ›ãƒ¼ãƒ </div><span style="margin-left:auto;
    font-weight:bold;">è¨ªã‚ŒãŸè”µ</span></div>
    <div class="container">
        <button onclick="openEditPage('brewery')" style="width:100%; padding:15px; background:white;
        border:2px dashed var(--accent); color:var(--accent); font-weight:bold; border-radius:12px; margin-bottom:20px; font-size:16px; cursor:pointer;">ï¼‹ æ–°ã—ã„è”µã‚’ç™»éŒ²ã™ã‚‹</button>
        <div id="breweryListContainer"></div>
    </div>
</div>

<div id="sakeModal" class="modal">
    <div class="header" style="position:fixed;
    width:100%; background:linear-gradient(rgba(0,0,0,0.6), transparent); box-shadow:none;">
        <div class="back-btn" onclick="closeModal('sakeModal')" style="background:rgba(0,0,0,0.5);
        border:1px solid white;">âœ• é–‰ã˜ã‚‹</div>
    </div>
    <img id="mSakeImg" class="modal-img">
    <div class="modal-body">
        <h2 id="mSakeName" style="margin:0;
        font-size:24px; color:var(--primary);"></h2>
        <p id="mSakeSub" style="color:#666; font-size:14px; margin-top:5px;
        font-weight:bold;"></p>
        <div id="mSakeTags" style="display:flex; flex-wrap:wrap; gap:5px;
        margin:15px 0;"></div>
        
        <div style="background:#fcf8f0; padding:15px;
        border-radius:10px; margin:15px 0; display:flex; justify-content:space-between; align-items:center;">
            <strong style="color:var(--wood-dark);">ç”˜è¾›åº¦ (æ—¥æœ¬é…’åº¦)</strong> 
            <span id="mSakeDeg" style="font-size:18px;
            font-weight:bold; color:var(--accent);"></span>
        </div>
        
        <div style="width:100%;
        max-width:300px; margin:0 auto;"><canvas id="sakeChart" height="250"></canvas></div>
        
        <p id="mSakeMemo" style="white-space:pre-wrap;
        border-top:1px dashed #ccc; padding-top:15px; margin-top:15px; color:#444; font-size:14px; line-height:1.6;"></p>
        <button style="width:100%; margin-top:30px;
        border:1px solid #ff4d4d; background:white; color:#ff4d4d; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;" onclick="deleteSake()">ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã™ã‚‹</button>
    </div>
</div>

<div id="breweryModal" class="modal">
    <div class="header" style="position:fixed;
    width:100%; background:linear-gradient(rgba(0,0,0,0.6), transparent); box-shadow:none;">
        <div class="back-btn" onclick="closeModal('breweryModal')" style="background:rgba(0,0,0,0.5);
        border:1px solid white;">âœ• é–‰ã˜ã‚‹</div>
    </div>
    <img id="mBrewImg" class="modal-img">
    <div class="modal-body">
        <h2 id="mBrewName" style="margin:0;
        font-size:24px; color:var(--primary);"></h2>
        <p id="mBrewLoc" style="color:var(--accent); font-weight:bold;
        margin-top:5px;"></p>
        <a id="mBrewUrl" href="#" target="_blank" style="word-break:break-all; font-size:13px; color:#3498db; text-decoration:none; display:block;
        margin-bottom:15px;"></a>
        
        <div style="background:#fcf8f0; padding:15px; border-radius:10px;
        margin:15px 0;">
            <label style="font-weight:bold; font-size:12px;
            color:var(--wood-dark);"><i class="fas fa-book-open"></i> æ€ã„å‡ºãƒ»ãƒ¡ãƒ¢</label>
            <p id="mBrewMemo" style="white-space:pre-wrap; margin-top:8px; font-size:14px;
            line-height:1.5; color:#444;"></p>
        </div>
        
        <h3 style="border-bottom:2px solid var(--accent);
        padding-bottom:8px; margin-top:30px; font-size:16px;">ğŸ¶ ã“ã®è”µã§é£²ã‚“ã ãŠé…’</h3>
        <div id="brewerySakeList">
            </div>
        
        <button style="width:100%;
        margin-top:40px; border:1px solid #ff4d4d; background:white; color:#ff4d4d; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;" onclick="deleteBrewery()">ã“ã®è”µæƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹</button>
    </div>
</div>

<script>
let sakeData = [];
let breweryData = [];
let currentSakeId = null;
let currentBrewId = null;
let currentSort = 'new';
let chartObj = null;

// éƒ½é“åºœçœŒã®ã‚½ãƒ¼ãƒˆé †ï¼ˆJISã‚³ãƒ¼ãƒ‰é †ï¼‰
const PREF_ORDER = ["åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ", "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ", "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"];
const TAGS = ["ç”Ÿé…’", "ç«å…¥ã‚Œ", "ç„¡æ¿¾é", "åŸé…’", "ç›´æ±²ã¿", "ä¸­å–ã‚Š", "ãŠã‚ŠãŒã‚‰ã¿", "ã«ã”ã‚Š", "ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£", "èŠ³é†‡", "æ·¡éº—", "æ—¨å£", "ã™ã£ãã‚Š", "æ–°é…’", "ã²ã‚„ãŠã‚ã—", "å¤é…’"];

window.onload = async () => {
    const tagContainer = document.getElementById('tagList');
    TAGS.forEach(t => {
        const btn = document.createElement('div');
        btn.className = 'tag-btn';
        btn.innerText = t;
        btn.onclick = () => btn.classList.toggle('selected');
        tagContainer.appendChild(btn);
    });

    localforage.config({ name: 'ak_SakeApp_DB' });
    try {
        sakeData = (await localforage.getItem('sake_db')) || [];
        breweryData = (await localforage.getItem('brew_db')) || [];
    } catch(e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e); }
    
    document.getElementById('loading').style.display = 'none';
};

// --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---
function goHome() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('homePage').classList.remove('hidden');
}

function openEditPage(type) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('homePage').classList.add('hidden');
    if (type === 'sake') {
        clearSakeForm();
        document.getElementById('editSakePage').classList.add('active');
    } else {
        clearBreweryForm();
        document.getElementById('editBreweryPage').classList.add('active');
    }
}

function openSearchPage() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('searchPage').classList.add('active');
    renderSakeSearch();
}

function openNationalListPage() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('nationalListPage').classList.add('active');
    renderNationalList();
}

function openShelfPage() {
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('shelfPage').classList.add('active');
    renderShelf();
}

function showBreweryList() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('breweryListPage').classList.add('active');
    
    const container = document.getElementById('breweryListContainer');
    container.innerHTML = breweryData.length === 0 ? '<p style="text-align:center; color:#888;">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>' : '';
    breweryData.forEach(b => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.onclick = () => showBreweryDetail(b);
        card.innerHTML = `<img src="${b.img || 'https://via.placeholder.com/80'}" class="item-thumb"><div class="item-info"><h3>${b.name}</h3><p><i class="fas fa-map-marker-alt"></i> ${b.loc}</p></div>`;
        container.appendChild(card);
    });
}

// --- ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç† ---
function clearSakeForm() { /* çœç•¥ã›ãšã«ãƒªã‚»ãƒƒãƒˆ */
    document.getElementById('sakeName').value = ''; document.getElementById('sakeRank').value = '';
    document.getElementById('sakeBrewery').value = ''; document.getElementById('sakePref').value = '';
    document.getElementById('sakeShelfNo').value = ''; document.getElementById('sakeDegree').value = 0; updateDegreeDisplay(0);
    document.getElementById('sakeCustomTag').value = ''; document.getElementById('sakeMemo').value = '';
    [1,2,3,4,5,6].forEach(i => document.getElementById(`p${i}`).value = (i===5 ? 1 : 3));
    document.querySelectorAll('.tag-btn.selected').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('sakeImgPreview').style.display = 'none'; document.getElementById('sakeImgPreview').src = '';
    document.getElementById('sakeImgPlaceholder').style.display = 'block';
}
function clearBreweryForm() {
    document.getElementById('brewName').value = ''; document.getElementById('brewLoc').value = '';
    document.getElementById('brewUrl').value = '';
    document.getElementById('brewMemo').value = '';
    document.getElementById('brewImgPreview').style.display = 'none'; document.getElementById('brewImgPreview').src = '';
    document.getElementById('brewImgPlaceholder').style.display = 'block';
}

function previewImage(input, previewId, placeholderId) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const max = 600;
            let w = img.width, h = img.height;
            if (w > h && w > max) { h *= max/w; w = max;
            } else if (h > max) { w *= max/h; h = max;
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            document.getElementById(previewId).src = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById(previewId).style.display = 'block';
            document.getElementById(placeholderId).style.display = 'none';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function updateDegreeDisplay(val) { document.getElementById('degDisp').innerText = parseFloat(val) > 0 ? `+${parseFloat(val)}` : parseFloat(val);
}

async function saveSake() {
    const name = document.getElementById('sakeName').value;
    if (!name) return alert('éŠ˜æŸ„åã¯å¿…é ˆã§ã™ï¼');
    let tags = Array.from(document.querySelectorAll('.tag-btn.selected')).map(el => el.innerText);
    const custom = document.getElementById('sakeCustomTag').value;
    if (custom) tags = tags.concat(custom.split(',').map(t => t.trim()).filter(t => t));
    const newItem = {
        id: Date.now(), name,
        rank: document.getElementById('sakeRank').value,
        brewery: document.getElementById('sakeBrewery').value,
        pref: document.getElementById('sakePref').value,
        shelfNo: parseInt(document.getElementById('sakeShelfNo').value) || null,
        degree: parseFloat(document.getElementById('sakeDegree').value),
        tags, params: [1,2,3,4,5,6].map(i => parseInt(document.getElementById(`p${i}`).value) || 3),
        memo: document.getElementById('sakeMemo').value,
        img: document.getElementById('sakeImgPreview').src
    };
    sakeData.unshift(newItem);
    await localforage.setItem('sake_db', sakeData);
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼'); goHome();
}

async function saveBrewery() {
    const name = document.getElementById('brewName').value;
    if (!name) return alert('è”µåã¯å¿…é ˆã§ã™ï¼');
    const newItem = {
        id: Date.now(), name,
        loc: document.getElementById('brewLoc').value,
        url: document.getElementById('brewUrl').value,
        memo: document.getElementById('brewMemo').value,
        img: document.getElementById('brewImgPreview').src
    };
    breweryData.unshift(newItem);
    await localforage.setItem('brew_db', breweryData);
    alert('è”µã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼'); 
    showBreweryList(); // è”µãƒªã‚¹ãƒˆã«æˆ»ã‚‹
}

// --- ãƒªã‚¹ãƒˆãƒ»æ¤œç´¢æç”» ---
function setSort(s) {
    currentSort = s;
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderSakeSearch();
}

// æ¤œç´¢ç”¨ï¼ˆãƒªã‚¹ãƒˆè¡¨ç¤ºï¼‰
function renderSakeSearch() {
    const container = document.getElementById('sakeSearchContainer');
    const query = document.getElementById('searchInput').value.toLowerCase();
    container.innerHTML = '';

    let list = [...sakeData];
    if (currentSort === 'sweet') list.sort((a,b) => a.degree - b.degree);
    else if (currentSort === 'dry') list.sort((a,b) => b.degree - a.degree);
    list.filter(d => {
        const tagStr = d.tags ? d.tags.join(' ') : '';
        return (d.name + (d.brewery||'') + (d.pref||'') + tagStr).toLowerCase().includes(query);
    }).forEach(d => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.onclick = () => showSakeDetail(d);
        card.innerHTML = `<img src="${d.img || 'https://via.placeholder.com/80'}" class="item-thumb"><div class="item-info"><h3>${d.name}</h3><p>${d.rank || ''} ${d.brewery ? '/ '+d.brewery : ''}</p><p style="font-weight:bold;">ç”˜è¾›åº¦: ${d.degree > 0 ? '+'+d.degree : d.degree}</p></div>`;
        container.appendChild(card);
    });
}

// å…±é€šã®ã‚·ã‚§ãƒ«ãƒ•ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæ¨ª5åˆ—ã®ãƒœãƒˆãƒ«ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function createShelfBottle(sake) {
    const bottle = document.createElement('div');
    bottle.className = 'shelf-bottle';
    bottle.onclick = () => { closeModal('breweryModal');
    showSakeDetail(sake); };
    
    let html = '';
    if (sake.shelfNo) html += `<div class="shelf-no">${sake.shelfNo}</div>`;
    html += `<img src="${sake.img || 'https://via.placeholder.com/80'}"><div class="bottle-name">${sake.name}</div>`;
    bottle.innerHTML = html;
    return bottle;
}

// â˜…æ–°è¨­ï¼šå…¨å›½ãƒªã‚¹ãƒˆ (éƒ½é“åºœçœŒé † > è”µé †) æ¨ª5åˆ—ã‚°ãƒªãƒƒãƒ‰
function renderNationalList() {
    const container = document.getElementById('nationalListContainer');
    container.innerHTML = '';

    // éƒ½é“åºœçœŒãƒ»è”µã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    let grouped = {};
    sakeData.forEach(s => {
        let p = s.pref || 'ãã®ä»–';
        let b = s.brewery || 'è”µåä¸æ˜';
        if(!grouped[p]) grouped[p] = {};
        if(!grouped[p][b]) grouped[p][b] = [];
        grouped[p][b].push(s);
    });
    // é †ç•ªã«æç”»
    const allPrefs = [...PREF_ORDER, 'ãã®ä»–'];
    allPrefs.forEach(p => {
        if(!grouped[p]) return;
        
        const prefHeader = document.createElement('h3');
        prefHeader.className = 'list-pref-header';
        prefHeader.innerText = `ğŸ—¾ ${p}`;
        container.appendChild(prefHeader);

        Object.keys(grouped[p]).forEach(b => {
            const brewHeader = document.createElement('h4');
            brewHeader.className = 'list-brew-header';
            brewHeader.innerHTML = `<i class="fas fa-building" style="color:var(--accent);"></i> ${b}`;
            container.appendChild(brewHeader);

            const grid = document.createElement('div');
            grid.className = 'shelf-grid';
            
            grouped[p][b].forEach(s => grid.appendChild(createShelfBottle(s)));
            container.appendChild(grid);
        });
    });
}

// AKæ£š (1-50, 51-100) æ¨ª5åˆ—ã‚°ãƒªãƒƒãƒ‰
function renderShelf() {
    const lim = document.getElementById('shelfLimited');
    const std = document.getElementById('shelfStandard');
    lim.innerHTML = ''; std.innerHTML = '';

    const list = [...sakeData].filter(d => d.shelfNo).sort((a,b) => a.shelfNo - b.shelfNo);
    const gridLim = document.createElement('div'); gridLim.className = 'shelf-grid';
    const gridStd = document.createElement('div'); gridStd.className = 'shelf-grid';
    list.forEach(d => {
        if (d.shelfNo <= 50) gridLim.appendChild(createShelfBottle(d));
        else gridStd.appendChild(createShelfBottle(d));
    });
    lim.appendChild(gridLim);
    std.appendChild(gridStd);
}

// --- è©³ç´°ç”»é¢ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰è¡¨ç¤º ---
function showSakeDetail(d) {
    currentSakeId = d.id;
    document.getElementById('mSakeName').innerText = d.name;
    document.getElementById('mSakeSub').innerText = `${d.rank || ''} ${d.brewery ? '| '+d.brewery : ''} ${d.pref ? '('+d.pref+')' : ''}`;
    document.getElementById('mSakeImg').src = d.img || 'https://via.placeholder.com/400x350';
    let degLabel = d.degree > 2 ? "(è¾›å£)" : (d.degree < -2 ? "(ç”˜å£)" : "(ä¸­å£)");
    document.getElementById('mSakeDeg').innerText = `${d.degree > 0 ? '+'+d.degree : d.degree} ${degLabel}`;
    document.getElementById('mSakeMemo').innerText = d.memo || "ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“";
    document.getElementById('mSakeTags').innerHTML = d.tags.map(t => `<span class="tag-btn" style="background:var(--primary); color:white; border:none; padding:4px 10px; font-size:11px;">#${t}</span>`).join('');
    
    document.getElementById('sakeModal').classList.add('active');

    if (chartObj) chartObj.destroy();
    chartObj = new Chart(document.getElementById('sakeChart'), {
        type: 'radar',
        data: {
            labels: ["é¦™ã‚Š", "ã‚­ãƒ¬", "ã‚³ã‚¯", "é…¸å‘³", "ç‚­é…¸", "ç”˜å‘³"],
            datasets: [{ data: d.params, backgroundColor: 'rgba(201, 166, 107, 0.5)', borderColor: '#c9a66b', pointBackgroundColor: '#5e3b1f', borderWidth: 2 }]
        },
        options: { maintainAspectRatio: false, scales: { r: { min: 0, max: 6, stepSize: 1, ticks: { display: false } } }, plugins: { legend: { display: false } } }
    });
}

function showBreweryDetail(b) {
    currentBrewId = b.id;
    document.getElementById('mBrewName').innerText = b.name;
    document.getElementById('mBrewLoc').innerText = b.loc ? `ğŸ“ ${b.loc}` : '';
    document.getElementById('mBrewUrl').innerText = b.url || ''; document.getElementById('mBrewUrl').href = b.url || '#';
    document.getElementById('mBrewUrl').style.display = b.url ? 'block' : 'none';
    document.getElementById('mBrewMemo').innerText = b.memo || "ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“";
    document.getElementById('mBrewImg').src = b.img || 'https://via.placeholder.com/400x350';
    // â˜… è”µã¨ãŠé…’ã®ãƒªãƒ³ã‚¯ï¼šåŒã˜è”µåãŒå«ã¾ã‚Œã‚‹ãŠé…’ã‚’æ¢ã—ã¦ã€æ¨ª5åˆ—ã®ã‚°ãƒªãƒƒãƒ‰ã§ä¸¦ã¹ã‚‹
    const sakes = sakeData.filter(s => (s.brewery||'').includes(b.name));
    const listDiv = document.getElementById('brewerySakeList');
    listDiv.innerHTML = '';
    if(sakes.length === 0) {
        listDiv.innerHTML = '<p style="color:#999;font-size:13px;">ã¾ã ã“ã®è”µã®ãŠé…’ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
    } else {
        const grid = document.createElement('div');
        grid.className = 'shelf-grid';
        sakes.forEach(s => grid.appendChild(createShelfBottle(s)));
        listDiv.appendChild(grid);
    }

    document.getElementById('breweryModal').classList.add('active');
}

function closeModal(id) { document.getElementById(id).classList.remove('active');
}

// --- å‰Šé™¤ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ---
async function deleteSake() {
    if (!confirm('æœ¬å½“ã«ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    sakeData = sakeData.filter(s => s.id !== currentSakeId);
    await localforage.setItem('sake_db', sakeData);
    closeModal('sakeModal');
    if(document.getElementById('searchPage').classList.contains('active')) renderSakeSearch();
    if(document.getElementById('nationalListPage').classList.contains('active')) renderNationalList();
    if(document.getElementById('shelfPage').classList.contains('active')) renderShelf();
}
async function deleteBrewery() {
    if (!confirm('æœ¬å½“ã«ã“ã®è”µæƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    breweryData = breweryData.filter(b => b.id !== currentBrewId);
    await localforage.setItem('brew_db', breweryData);
    closeModal('breweryModal'); showBreweryList();
}
async function exportData() {
    const text = JSON.stringify({ sake: sakeData, brew: breweryData });
    const temp = document.createElement("textarea");
    temp.value = text; document.body.appendChild(temp); temp.select();
    try { document.execCommand("copy"); alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã®Keepã‚„ãƒ¡ãƒ¢å¸³ã«è²¼ã‚Šä»˜ã‘ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚"); } 
    catch(e) { alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"); } document.body.removeChild(temp);
}
async function importData() {
    const raw = prompt('ä¿ç®¡ã—ã¦ã„ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ–‡å­—åˆ—ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
    if (raw) {
        try {
            const data = JSON.parse(raw);
            if(data.sake) await localforage.setItem('sake_db', data.sake);
            if(data.brew) await localforage.setItem('brew_db', data.brew);
            alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼'); location.reload();
        } catch(e) { alert("ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
    }
}
</script>
</body>
</html>
