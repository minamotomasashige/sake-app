<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ak æ—¥æœ¬é…’ãƒ­ã‚° ç©¶æ¥µå®Œå…¨ç‰ˆ Final</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<style>
    :root {
        --primary: #2c3e50;
        --accent: #c9a66b;
        --bg: #f8f9fa;
        --card-bg: #ffffff;
        --text: #333;
        --danger: #e74c3c;
    }
    body {
        font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        padding-bottom: 40px;
    }
    /* ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ï¼ˆä¸­å¤®å¯„ã›ï¼‰ */
    #homePage {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }
    h1 {
        text-align: center;
        color: var(--primary);
        font-size: 32px;
        margin-bottom: 40px;
        letter-spacing: 2px;
    }
    .menu-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    .menu-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 30px 10px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.1s;
        border: 1px solid rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 140px; /* é«˜ã•çµ±ä¸€ */
        box-sizing: border-box;
    }
    .menu-card:active { transform: scale(0.98); }
    .menu-title {
        font-size: 16px;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 10px;
        font-family: "Hiragino Kaku Gothic ProN", sans-serif;
    }
    .menu-icon { font-size: 36px; }

    /* AKæ£šãƒœã‚¿ãƒ³ã‚’å¤§ãããƒªãƒƒãƒã« */
    .ak-shelf-card {
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: white;
        width: 100%;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin-top: 10px;
        box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
        cursor: pointer;
        box-sizing: border-box;
    }
    .ak-shelf-title {
        font-size: 18px;
        font-weight: bold;
        letter-spacing: 1px;
    }

    /* å…±é€šUI */
    .page {
        display: none;
        min-height: 100vh;
        background: var(--bg);
        padding-bottom: 80px;
    }
    .page.active { display: block; }
    .header {
        background: var(--primary);
        color: white;
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .back-btn {
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        background: rgba(255,255,255,0.15);
        padding: 5px 12px;
        border-radius: 20px;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ å‘¨ã‚Š */
    .container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .form-group { margin-bottom: 25px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .form-group label {
        display: block;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 10px;
        border-left: 4px solid var(--accent);
        padding-left: 10px;
        font-size: 15px;
    }
    input[type="text"], textarea, input[type="number"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        margin-bottom: 10px;
    }

    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ */
    .tags-wrapper { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
    .tag-btn {
        border: 1px solid #ddd;
        background: #fff;
        color: #666;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        cursor: pointer;
    }
    .tag-btn.selected {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
    }

    /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
    .image-upload-box {
        background: #f0f0f0;
        height: 200px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #888;
        border: 2px dashed #ccc;
        cursor: pointer;
        margin-bottom: 20px;
        overflow: hidden;
        position: relative;
    }
    .image-upload-box img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0; left: 0;
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆç”˜è¾›ï¼‰ */
    .range-wrap {
        display: flex; align-items: center; gap: 10px;
        margin-top: 10px;
    }
    input[type=range] { flex: 1; accent-color: var(--primary); }
    .range-labels {
        display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;
    }
    .degree-val {
        text-align: center; font-size: 24px; font-weight: bold; color: var(--accent); margin-bottom: 5px;
    }

    /* 6è§’å½¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ */
    .param-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
    .param-item label { border: none; font-size: 12px; margin-bottom: 2px; }

    /* ä¿å­˜ãƒœã‚¿ãƒ³ */
    .save-btn {
        background: var(--primary); color: white; width: 100%; padding: 16px;
        border: none; border-radius: 30px; font-size: 18px; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: 20px;
    }

    /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
    .list-container { padding: 10px; }
    .sake-item {
        background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
        display: flex; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
    }
    .sake-thumb {
        width: 70px; height: 70px; background: #eee; border-radius: 8px; object-fit: cover; flex-shrink: 0;
    }
    .sake-details h3 { margin: 0 0 5px 0; font-size: 18px; color: var(--primary); }
    .sake-details p { margin: 0; font-size: 13px; color: #666; line-height: 1.4; }

    /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .detail-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: white; z-index: 200; overflow-y: auto; display: none;
    }
    .detail-modal.active { display: block; }
    .detail-img-area {
        width: 100%; height: 350px; background: #222; position: relative;
    }
    .detail-img-area img { width: 100%; height: 100%; object-fit: contain; }
    .detail-body {
        padding: 25px; background: white; border-radius: 25px 25px 0 0; margin-top: -25px; position: relative; min-height: 50vh;
    }
    .close-modal {
        position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6);
        color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; z-index: 201; font-size: 14px;
    }
    .btn-group { display: flex; gap: 10px; margin-top: 30px; }
    .btn-group button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; }
    .edit-btn { background: #eee; color: #333; }
    .del-btn { background: #ffebeb; color: var(--danger); }

    /* ãƒ‡ãƒ¼ã‚¿æ“ä½œç³» */
    .data-tools {
        display: flex; justify-content: center; gap: 20px; margin-top: 30px;
    }
    .tool-link { font-size: 12px; color: #999; text-decoration: underline; cursor: pointer; }

    /* è”µãƒªã‚¹ãƒˆ */
    .brewery-item {
        background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;
    }
</style>
</head>
<body>

<div id="homePage">
    <h1>ak æ—¥æœ¬é…’ãƒ­ã‚°</h1>
    
    <div class="menu-grid">
        <div class="menu-card" onclick="openAddPage()">
            <div class="menu-title">æ—¥æœ¬é…’ã‚’è¿½åŠ </div>
            <div class="menu-icon">ğŸ¶ï¼‹</div>
        </div>
        <div class="menu-card" onclick="openBreweryList()">
            <div class="menu-title">è¨ªã‚ŒãŸè”µ</div>
            <div class="menu-icon">ğŸ </div>
        </div>
        <div class="menu-card" onclick="openList('all')">
            <div class="menu-title">æ¤œç´¢ãƒ»ä¸¦ã³æ›¿ãˆ</div>
            <div class="menu-icon">ğŸ”</div>
        </div>
        <div class="menu-card" onclick="openList('all')">
            <div class="menu-title">é£²ã‚“ã ãƒªã‚¹ãƒˆ</div>
            <div class="menu-icon">ğŸ“‹</div>
        </div>
    </div>

    <div class="ak-shelf-card" onclick="openList('shelf')">
        <div class="ak-shelf-title">AKæ—¥æœ¬é…’æ£š (Best Selection)</div>
        <div style="font-size: 24px; margin-top: 5px;">ğŸ‘‘</div>
    </div>

    <div class="data-tools">
        <span class="tool-link" onclick="backupData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
        <span class="tool-link" onclick="restoreData()">å¾©å…ƒ</span>
    </div>
</div>

<div id="editPage" class="page">
    <div class="header">
        <div class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i> ãƒ›ãƒ¼ãƒ ã¸</div>
        <span style="margin-left:auto; font-weight:bold;">æ—¥æœ¬é…’ã®è¨˜éŒ²</span>
    </div>
    <div class="container">
        
        <div class="image-upload-box" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-camera" style="font-size:30px; margin-bottom:10px;"></i>
            <span id="uploadMsg">å†™çœŸã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¿½åŠ </span>
            <img id="previewImg" style="display:none;">
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImage(event)">

        <div class="form-group">
            <label>éŠ˜æŸ„ãƒ»è”µå…ƒ</label>
            <input type="text" id="inputName" placeholder="éŠ˜æŸ„åï¼ˆä¾‹ï¼šå¿ƒæ˜Ÿï¼‰">
            <input type="text" id="inputBrewery" placeholder="è”µå…ƒï¼ˆä¾‹ï¼šèŠã®å¸é…’é€ ï¼‰">
            <input type="text" id="inputPref" placeholder="éƒ½é“åºœçœŒï¼ˆä¾‹ï¼šå²©æ‰‹çœŒï¼‰">

            <label style="margin-top:20px;">ç‰¹å¾´ã‚¿ã‚°</label>
            <div class="tags-wrapper" id="tagButtons">
                </div>
            <input type="text" id="inputCustomTag" placeholder="ãã®ä»–ã‚¿ã‚°ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰" style="margin-top:10px;">
        </div>

        <div class="form-group">
            <label>ç”˜è¾›åº¦ (å·¦:ç”˜å£ / å³:è¾›å£)</label>
            <div class="degree-val" id="degreeDisp">0</div>
            <div class="range-wrap">
                <span style="font-size:12px; font-weight:bold; color:#e67e22;">ç”˜ (-5)</span>
                <input type="range" id="inputDegree" min="-5" max="5" step="1" value="0" oninput="updateDegree(this.value)">
                <span style="font-size:12px; font-weight:bold; color:#2980b9;">è¾› (+5)</span>
            </div>
        </div>

        <div class="form-group">
            <label>å‘³ã‚ã„ãƒãƒ£ãƒ¼ãƒˆ (1-6)</label>
            <div class="param-grid">
                <div class="param-item"><label>é¦™ã‚Š</label><input type="number" id="p_kaori" min="1" max="6" value="3"></div>
                <div class="param-item"><label>ã‚­ãƒ¬</label><input type="number" id="p_kire" min="1" max="6" value="3"></div>
                <div class="param-item"><label>ã‚³ã‚¯</label><input type="number" id="p_koku" min="1" max="6" value="3"></div>
                <div class="param-item"><label>é…¸å‘³</label><input type="number" id="p_sanmi" min="1" max="6" value="3"></div>
                <div class="param-item"><label>ç‚­é…¸</label><input type="number" id="p_tansan" min="1" max="6" value="3"></div>
                <div class="param-item"><label>ç”˜å‘³</label><input type="number" id="p_amami" min="1" max="6" value="3"></div>
            </div>
        </div>

        <div class="form-group" style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="inputAkShelf" style="width:20px; height:20px;">
            <label for="inputAkShelf" style="border:none; margin:0; padding:0; cursor:pointer;">AKæ—¥æœ¬é…’æ£šã«å…¥ã‚Œã‚‹</label>
        </div>

        <div class="form-group">
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="inputMemo" rows="4" placeholder="æ„Ÿæƒ³ãªã©..."></textarea>
        </div>

        <button class="save-btn" onclick="saveData()">ä¿å­˜ã™ã‚‹</button>
    </div>
</div>

<div id="listPage" class="page">
    <div class="header">
        <div class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i> ãƒ›ãƒ¼ãƒ </div>
        <span style="margin-left:auto; font-weight:bold;" id="listTitle">ãƒªã‚¹ãƒˆ</span>
    </div>
    <div style="padding:10px 20px; background:white;">
        <input type="text" id="searchBox" placeholder="åå‰ã‚„å ´æ‰€ã§æ¤œç´¢..." oninput="renderList()" style="margin:0;">
    </div>
    <div class="list-container" id="listContainer"></div>
</div>

<div id="detailModal" class="detail-modal">
    <div class="close-modal" onclick="closeDetail()"><i class="fas fa-times"></i> é–‰ã˜ã‚‹</div>
    <div class="detail-img-area">
        <img id="detailImg" src="">
    </div>
    <div class="detail-body">
        <h2 id="detailName" style="margin:0 0 5px 0; color:var(--primary); font-family:serif;"></h2>
        <p id="detailSub" style="color:#666; margin-bottom:15px;"></p>
        
        <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:15px;" id="detailTags"></div>
        
        <div style="margin-bottom:20px; padding:15px; background:#f9f9f9; border-radius:10px;">
            <strong>ç”˜è¾›åº¦:</strong> <span id="detailDegreeVal" style="font-weight:bold; font-size:18px;"></span>
        </div>

        <div style="height:250px; position:relative; margin-bottom:20px;">
            <canvas id="detailChart"></canvas>
        </div>

        <div style="background:#f9f9f9; padding:15px; border-radius:10px; line-height:1.6;">
            <p id="detailMemo" style="white-space:pre-wrap; margin:0;"></p>
        </div>

        <div class="btn-group">
            <button class="edit-btn" onclick="editCurrent()">ç·¨é›†</button>
            <button class="del-btn" onclick="deleteCurrent()">å‰Šé™¤</button>
        </div>
        <div style="height:50px;"></div>
    </div>
</div>

<script>
    // === ãƒ‡ãƒ¼ã‚¿ç®¡ç† ===
    let sakeData = [];
    const TAG_LIST = ["ç”Ÿé…’", "ç«å…¥ã‚Œ", "ç„¡æ¿¾é", "åŸé…’", "ç´”ç±³", "ç´”ç±³åŸé†¸", "ç´”ç±³å¤§åŸé†¸", "ç‰¹åˆ¥ç´”ç±³", "å¤§åŸé†¸", "æœ¬é†¸é€ ", "ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£", "è¾›å£", "ç”˜å£"];
    let currentEditId = null;
    let currentImgBase64 = null;
    let detailChartObj = null;
    let currentFilter = 'all'; // 'all', 'shelf', 'brewery'

    window.onload = function() {
        const saved = localStorage.getItem('akSakeLogFinal');
        if(saved) sakeData = JSON.parse(saved);
        
        // åˆæœŸã‚¿ã‚°ãƒœã‚¿ãƒ³ç”Ÿæˆ
        const tagBox = document.getElementById('tagButtons');
        TAG_LIST.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'tag-btn';
            btn.textContent = t;
            btn.onclick = () => btn.classList.toggle('selected');
            tagBox.appendChild(btn);
        });
    };

    function saveToLS() {
        localStorage.setItem('akSakeLogFinal', JSON.stringify(sakeData));
    }

    // === ç”»é¢é·ç§» ===
    function goHome() {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('homePage').style.display = 'flex'; // Flexã«æˆ»ã™
    }
    function openPage(id) {
        document.getElementById('homePage').style.display = 'none';
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // === è¿½åŠ ãƒ»ç·¨é›†ãƒ­ã‚¸ãƒƒã‚¯ (V2ã®ã‚¿ã‚°ä¿æŒãƒ­ã‚¸ãƒƒã‚¯æ¡ç”¨) ===
    function openAddPage() {
        resetForm();
        currentEditId = null;
        openPage('editPage');
    }

    function resetForm() {
        document.getElementById('inputName').value = '';
        document.getElementById('inputBrewery').value = '';
        document.getElementById('inputPref').value = '';
        document.getElementById('inputCustomTag').value = '';
        document.getElementById('inputMemo').value = '';
        document.getElementById('inputDegree').value = 0;
        document.getElementById('degreeDisp').textContent = "0";
        document.getElementById('inputAkShelf').checked = false;
        
        ['kaori','kire','koku','sanmi','tansan','amami'].forEach(k => document.getElementById('p_'+k).value = 3);
        
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('selected'));
        
        currentImgBase64 = null;
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('uploadMsg').style.display = 'block';
    }

    // ç”»åƒåœ§ç¸®å‡¦ç† (V1å¾©åˆ»)
    function handleImage(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const maxSize = 800; // åœ§ç¸®ã‚µã‚¤ã‚º
                if (width > height && width > maxSize) {
                    height *= maxSize / width; width = maxSize;
                } else if (height > maxSize) {
                    width *= maxSize / height; height = maxSize;
                }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                currentImgBase64 = canvas.toDataURL('image/jpeg', 0.7); // åœ§ç¸®ç‡0.7
                
                document.getElementById('previewImg').src = currentImgBase64;
                document.getElementById('previewImg').style.display = 'block';
                document.getElementById('uploadMsg').style.display = 'none';
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function updateDegree(val) {
        const num = parseInt(val);
        let text = num === 0 ? "0" : (num > 0 ? "+"+num : num);
        document.getElementById('degreeDisp').textContent = text;
    }

    function saveData() {
        const name = document.getElementById('inputName').value;
        if(!name) { alert('éŠ˜æŸ„åã¯å¿…é ˆã§ã™'); return; }

        // ã‚¿ã‚°å–å¾—
        const selectedTags = Array.from(document.querySelectorAll('.tag-btn.selected')).map(b => b.textContent);
        if(document.getElementById('inputCustomTag').value) {
            selectedTags.push(document.getElementById('inputCustomTag').value);
        }

        const newData = {
            id: currentEditId || Date.now(),
            name: name,
            brewery: document.getElementById('inputBrewery').value,
            pref: document.getElementById('inputPref').value,
            tags: selectedTags,
            degree: parseInt(document.getElementById('inputDegree').value),
            akShelf: document.getElementById('inputAkShelf').checked,
            params: {
                kaori: parseInt(document.getElementById('p_kaori').value),
                kire: parseInt(document.getElementById('p_kire').value),
                koku: parseInt(document.getElementById('p_koku').value),
                sanmi: parseInt(document.getElementById('p_sanmi').value),
                tansan: parseInt(document.getElementById('p_tansan').value),
                amami: parseInt(document.getElementById('p_amami').value)
            },
            memo: document.getElementById('inputMemo').value,
            img: currentImgBase64,
            date: new Date().toISOString()
        };

        if(currentEditId) {
            const idx = sakeData.findIndex(d => d.id === currentEditId);
            if(idx !== -1) sakeData[idx] = newData;
        } else {
            sakeData.unshift(newData);
        }
        
        saveToLS();
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        goHome();
    }

    // === ãƒªã‚¹ãƒˆè¡¨ç¤º & æ¤œç´¢ ===
    function openList(mode) {
        currentFilter = mode;
        const titleEl = document.getElementById('listTitle');
        if(mode === 'shelf') titleEl.textContent = "AKæ—¥æœ¬é…’æ£š";
        else if(mode === 'all') titleEl.textContent = "é£²ã‚“ã ãƒªã‚¹ãƒˆ";
        
        renderList();
        openPage('listPage');
    }
    
    // è”µãƒªã‚¹ãƒˆæ©Ÿèƒ½
    function openBreweryList() {
        // è”µã®ä¸€è¦§ã‚’ç”Ÿæˆ
        const breweries = [...new Set(sakeData.map(d => d.brewery).filter(b => b))];
        const container = document.getElementById('listContainer');
        container.innerHTML = '';
        document.getElementById('listTitle').textContent = "è¨ªã‚ŒãŸè”µãƒªã‚¹ãƒˆ";
        document.getElementById('searchBox').style.display = 'none'; // è”µãƒªã‚¹ãƒˆã§ã¯æ¤œç´¢éš ã™

        breweries.sort().forEach(b => {
            const count = sakeData.filter(d => d.brewery === b).length;
            const div = document.createElement('div');
            div.className = 'brewery-item';
            div.innerHTML = `<strong>${b}</strong><span>${count}ç¨®</span>`;
            // ã‚¯ãƒªãƒƒã‚¯ã§ãã®è”µã®ãŠé…’ä¸€è¦§ã¸
            div.onclick = () => {
                document.getElementById('searchBox').value = b;
                document.getElementById('searchBox').style.display = 'block';
                openList('all');
            };
            container.appendChild(div);
        });
        openPage('listPage');
    }

    function renderList() {
        if(document.getElementById('listTitle').textContent === "è¨ªã‚ŒãŸè”µãƒªã‚¹ãƒˆ") return; // è”µãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„

        const term = document.getElementById('searchBox').value.toLowerCase();
        const container = document.getElementById('listContainer');
        container.innerHTML = '';

        let targets = sakeData;
        if(currentFilter === 'shelf') {
            targets = sakeData.filter(d => d.akShelf);
        }

        targets.filter(d => {
            return (d.name && d.name.toLowerCase().includes(term)) || 
                   (d.brewery && d.brewery.toLowerCase().includes(term)) ||
                   (d.pref && d.pref.toLowerCase().includes(term));
        }).forEach(d => {
            const div = document.createElement('div');
            div.className = 'sake-item';
            div.onclick = () => showDetail(d.id);
            
            const thumb = d.img ? d.img : 'https://via.placeholder.com/100x100?text=No+Img';
            const degText = d.degree > 0 ? `+${d.degree}` : d.degree;
            
            div.innerHTML = `
                <img src="${thumb}" class="sake-thumb">
                <div class="sake-details">
                    <h3>${d.name}</h3>
                    <p>${d.pref} / ${d.brewery}</p>
                    <p>ç”˜è¾›: ${degText} ${d.tags.slice(0,3).join(' ')}</p>
                </div>
            `;
            container.appendChild(div);
        });
        
        if(targets.length === 0) container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }

    // === è©³ç´°ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ ===
    function showDetail(id) {
        const d = sakeData.find(i => i.id === id);
        if(!d) return;
        
        currentEditId = id; // ç·¨é›†ãƒ»å‰Šé™¤ç”¨ã«ä¿æŒ
        
        document.getElementById('detailName').textContent = d.name;
        document.getElementById('detailSub').textContent = `${d.pref} / ${d.brewery}`;
        document.getElementById('detailImg').src = d.img || "";
        document.getElementById('detailImg').style.display = d.img ? 'block' : 'none';
        
        const tagsDiv = document.getElementById('detailTags');
        tagsDiv.innerHTML = d.tags.map(t => `<span style="background:#eee; padding:4px 10px; border-radius:15px; font-size:12px;">${t}</span>`).join('');
        
        const degText = d.degree > 0 ? `+${d.degree} (è¾›å£)` : (d.degree < 0 ? `${d.degree} (ç”˜å£)` : "0");
        document.getElementById('detailDegreeVal').textContent = degText;
        
        document.getElementById('detailMemo').textContent = d.memo;
        
        document.getElementById('detailModal').classList.add('active');
        
        // ãƒãƒ£ãƒ¼ãƒˆæç”»
        if(detailChartObj) detailChartObj.destroy();
        const ctx = document.getElementById('detailChart').getContext('2d');
        detailChartObj = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ç”˜å‘³', 'é¦™ã‚Š', 'ã‚­ãƒ¬', 'ã‚³ã‚¯', 'é…¸å‘³', 'ç‚­é…¸'],
                datasets: [{
                    label: 'å‘³ã‚ã„',
                    data: [d.params.amami, d.params.kaori, d.params.kire, d.params.koku, d.params.sanmi, d.params.tansan],
                    backgroundColor: 'rgba(201, 166, 107, 0.4)',
                    borderColor: '#c9a66b',
                    pointBackgroundColor: '#c9a66b'
                }]
            },
            options: {
                scales: { r: { min: 0, max: 6, ticks: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function closeDetail() {
        document.getElementById('detailModal').classList.remove('active');
    }

    function editCurrent() {
        const d = sakeData.find(i => i.id === currentEditId);
        if(!d) return;

        openAddPage();
        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
        currentEditId = d.id; // å†è¨­å®š
        document.getElementById('inputName').value = d.name;
        document.getElementById('inputBrewery').value = d.brewery;
        document.getElementById('inputPref').value = d.pref;
        document.getElementById('inputMemo').value = d.memo;
        document.getElementById('inputDegree').value = d.degree;
        updateDegree(d.degree);
        document.getElementById('inputAkShelf').checked = d.akShelf || false;
        
        // ã‚¿ã‚°ã®å¾©å…ƒ (V2ã®ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ)
        document.querySelectorAll('.tag-btn').forEach(btn => {
            if(d.tags.includes(btn.textContent)) {
                btn.classList.add('selected');
            }
        });
        // è‡ªç”±å…¥åŠ›ã‚¿ã‚°
        const custom = d.tags.filter(t => !TAG_LIST.includes(t));
        if(custom.length) document.getElementById('inputCustomTag').value = custom[0];
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        if(d.params) {
            Object.keys(d.params).forEach(k => {
                document.getElementById('p_'+k).value = d.params[k];
            });
        }
        
        // ç”»åƒ
        if(d.img) {
            currentImgBase64 = d.img;
            document.getElementById('previewImg').src = d.img;
            document.getElementById('previewImg').style.display = 'block';
            document.getElementById('uploadMsg').style.display = 'none';
        }
        
        closeDetail();
    }

    function deleteCurrent() {
        if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            sakeData = sakeData.filter(d => d.id !== currentEditId);
            saveToLS();
            closeDetail();
            renderList();
        }
    }

    // === ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ ===
    function backupData() {
        const str = JSON.stringify(sakeData);
        navigator.clipboard.writeText(str).then(() => alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¢å¸³ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„'));
    }
    function restoreData() {
        const str = prompt('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸæ–‡å­—åˆ—ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        if(str) {
            try {
                sakeData = JSON.parse(str);
                saveToLS();
                alert('å¾©å…ƒå®Œäº†ï¼');
                location.reload();
            } catch(e) {
                alert('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé–“é•ã£ã¦ã„ã¾ã™');
            }
        }
    }
</script>
</body>
</html>
