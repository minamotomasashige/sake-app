<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ak 日本酒ログ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #2c3e50;
        --accent: #d4af37; /* 金色 */
        --bg: #f9f9f9;
        --text: #333;
    }
    body {
        font-family: 'Noto Serif JP', serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding-bottom: 80px;
        -webkit-font-smoothing: antialiased;
    }
    
    /* ヘッダー */
    header {
        background: var(--primary);
        color: white;
        padding: 15px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; }
    .header-btn { background: none; border: 1px solid white; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }

    /* コンテナ */
    .container { padding: 20px; max-width: 600px; margin: 0 auto; }
    .hidden { display: none !important; }

    /* 入力フォーム */
    .form-group { margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .form-label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary); font-size: 0.9rem; border-left: 3px solid var(--accent); padding-left: 8px; }
    
    input[type="text"], input[type="number"], textarea, select {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        font-size: 1rem; box-sizing: border-box; margin-bottom: 10px;
        font-family: inherit; -webkit-appearance: none; appearance: none;
        background: #fff;
    }
    select {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }
    
    /* タグボタン */
    .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag-btn {
        padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px;
        background: white; color: #666; font-size: 0.85rem; cursor: pointer;
        transition: all 0.2s;
    }
    .tag-btn.active {
        background: var(--primary); color: white; border-color: var(--primary);
    }

    /* スライダー */
    .slider-container { text-align: center; padding: 10px 0; }
    input[type="range"] { width: 100%; accent-color: var(--primary); }
    .slider-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }
    .slider-val { font-size: 1.5rem; color: var(--accent); font-weight: bold; }

    /* リスト表示 */
    .sake-card {
        background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer;
        display: flex; align-items: center; gap: 15px; transition: transform 0.1s;
    }
    .sake-card:active { transform: scale(0.98); }
    .sake-thumb {
        width: 60px; height: 60px; background: #eee; border-radius: 8px; object-fit: cover; flex-shrink: 0;
    }
    .sake-info h3 { margin: 0 0 5px 0; color: var(--primary); font-size: 1.1rem; }
    .sake-info p { margin: 0; font-size: 0.85rem; color: #666; }
    .badge {
        display: inline-block; background: var(--accent); color: white;
        padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px;
    }

    /* 詳細モーダル */
    #modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 200; display: flex;
        align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-content {
        background: white; width: 90%; max-height: 90vh; overflow-y: auto;
        border-radius: 16px; padding: 20px; position: relative;
    }
    .close-modal {
        position: absolute; top: 15px; right: 15px; font-size: 1.5rem;
        background: #f0f0f0; border-radius: 50%; width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .detail-img { width: 100%; height: 250px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; background: #eee; }
    .detail-title { font-size: 1.8rem; color: var(--primary); margin: 0 0 5px 0; }
    .detail-sub { color: #666; margin-bottom: 15px; font-size: 0.9rem; }
    .chart-box { max-width: 300px; margin: 20px auto; }
    
    /* アクションボタン */
    .fab {
        position: fixed; bottom: 20px; right: 20px;
        background: var(--primary); color: white;
        width: 56px; height: 56px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        cursor: pointer; z-index: 90;
    }
    .btn-save {
        background: var(--primary); color: white; width: 100%; padding: 15px;
        border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; margin-top: 20px;
    }
    .btn-delete {
        background: #e74c3c; color: white; width: 100%; padding: 12px;
        border: none; border-radius: 8px; font-size: 0.9rem; margin-top: 10px;
    }
    
    /* パラメータ入力グリッド */
    .param-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
    .param-grid label { font-size: 0.8rem; display: block; margin-bottom: 5px; }
</style>
</head>
<body>

<header>
    <div id="header-left"></div>
    <h1>ak 日本酒ログ</h1>
    <div id="header-right"></div>
</header>

<div id="page-list" class="container">
    <div id="sake-list"></div>
    <div style="text-align:center; color:#999; margin-top:50px;" id="empty-msg">
        右下の＋ボタンから<br>最初の日本酒を記録しましょう
    </div>
</div>

<div id="page-edit" class="container hidden">
    <div class="form-group">
        <label class="form-label">基本情報</label>
        <input type="text" id="f-name" placeholder="銘柄名（例：心星）">
        <input type="text" id="f-maker" placeholder="蔵元（例：菊の司酒造）">
        <input type="text" id="f-pref" placeholder="都道府県（例：岩手県）">
        
        <label class="form-label" style="margin-top:10px;">特定名称（分類）</label>
        <select id="f-class">
            <option value="">▼ 選択してください</option>
            <option value="純米大吟醸">純米大吟醸</option>
            <option value="純米吟醸">純米吟醸</option>
            <option value="大吟醸">大吟醸</option>
            <option value="吟醸">吟醸</option>
            <option value="特別純米">特別純米</option>
            <option value="純米">純米</option>
            <option value="特別本醸造">特別本醸造</option>
            <option value="本醸造">本醸造</option>
            <option value="普通酒">普通酒</option>
            <option value="その他">その他</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-label">写真</label>
        <input type="file" id="f-image" accept="image/*" onchange="previewImage(this)">
        <img id="f-image-preview" style="width:100%; border-radius:8px; margin-top:10px; display:none;">
    </div>

    <div class="form-group">
        <label class="form-label">キーワード特徴</label>
        <div class="tag-container" id="tag-area">
            </div>
        <input type="text" id="f-custom-tag" placeholder="自由入力タグ（入力して完了で追加）" style="margin-top:10px; font-size:0.8rem;" onchange="addCustomTag(this.value)">
    </div>

    <div class="form-group">
        <label class="form-label">甘み ⇔ 辛み (<span id="smv-val">0</span>)</label>
        <div class="slider-container">
            <input type="range" id="f-smv" min="-5" max="5" step="1" value="0" oninput="document.getElementById('smv-val').innerText = this.value">
            <div class="slider-labels">
                <span>辛口 (-5)</span>
                <span>0</span>
                <span>甘口 (+5)</span>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">味わいパラメータ (1-5)</label>
        <div class="param-grid">
            <div><label>香り</label><input type="number" id="p-kaori" min="1" max="5" value="3"></div>
            <div><label>キレ</label><input type="number" id="p-kire" min="1" max="5" value="3"></div>
            <div><label>コク</label><input type="number" id="p-koku" min="1" max="5" value="3"></div>
            <div><label>酸味</label><input type="number" id="p-sanmi" min="1" max="5" value="3"></div>
            <div><label>甘味</label><input type="number" id="p-amami" min="1" max="5" value="3"></div>
            <div><label>苦渋</label><input type="number" id="p-kuju" min="1" max="5" value="3"></div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">メモ</label>
        <textarea id="f-memo" rows="4" placeholder="味の感想、飲んだ店、温度帯など..."></textarea>
    </div>

    <button class="btn-save" onclick="saveSake()">保存する</button>
    <button id="btn-delete" class="btn-delete hidden" onclick="deleteSake()">削除する</button>
    <div style="height:50px;"></div>
</div>

<div id="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <div class="close-modal" onclick="closeModalDirect()">×</div>
        <img id="m-img" class="detail-img">
        <h2 id="m-name" class="detail-title"></h2>
        <p id="m-sub" class="detail-sub"></p>
        <div id="m-tags" class="tag-container" style="margin-bottom:15px;"></div>
        
        <div style="margin-bottom:15px;">
            <span id="m-class-badge" style="background:#2c3e50; color:white; padding:4px 10px; border-radius:4px; font-size:0.85rem;"></span>
        </div>

        <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:15px;">
            <strong>甘辛度: <span id="m-smv" style="color:var(--accent); font-size:1.2rem;"></span></strong>
            <p id="m-memo" style="margin-top:10px; white-space: pre-wrap; line-height:1.6;"></p>
        </div>
        
        <div class="chart-box">
            <canvas id="detailChart"></canvas>
        </div>
        
        <button class="btn-save" onclick="editCurrentSake()" style="margin-top:0;">編集する</button>
    </div>
</div>

<div class="fab" onclick="showEdit()">＋</div>

<script>
    // データ管理
    let sakeList = [];
    let currentId = null;
    let myChart = null;

    // キーワードリスト（大幅に追加しました！）
    const BASE_TAGS = [
        "生酒", "火入れ", "フルーティ", "芳醇", "淡麗", 
        "無濾過", "原酒", "生原酒", "中取り", "あらばしり", "責め",
        "生酛", "山廃", "速醸", "袋吊り", "斗瓶囲い", "おりがらみ", "濁り酒",
        "ひやおろし", "秋あがり", "しぼりたて", "雪室貯蔵", "古酒", "スパークリング",
        "限定酒", "季節限定"
    ];

    document.addEventListener('DOMContentLoaded', () => {
        initTags();
        loadData();
    });

    function initTags() {
        const area = document.getElementById('tag-area');
        area.innerHTML = '';
        BASE_TAGS.forEach(tag => {
            const btn = document.createElement('div');
            btn.className = 'tag-btn';
            btn.innerText = tag;
            btn.onclick = () => btn.classList.toggle('active');
            area.appendChild(btn);
        });
    }

    // 自由入力タグ用
    function addCustomTag(val) {
        if(!val) return;
        const area = document.getElementById('tag-area');
        const btn = document.createElement('div');
        btn.className = 'tag-btn active'; // 追加したら即選択状態
        btn.innerText = val;
        btn.onclick = () => btn.classList.toggle('active');
        area.appendChild(btn);
        document.getElementById('f-custom-tag').value = '';
    }

    async function loadData() {
        sakeList = await localforage.getItem('ak_sake_list') || [];
        renderList();
    }

    function renderList() {
        const listEl = document.getElementById('sake-list');
        const emptyEl = document.getElementById('empty-msg');
        listEl.innerHTML = '';
        
        if (sakeList.length === 0) {
            emptyEl.style.display = 'block';
        } else {
            emptyEl.style.display = 'none';
            // 新しい順に表示
            [...sakeList].reverse().forEach(sake => {
                const card = document.createElement('div');
                card.className = 'sake-card';
                card.onclick = () => showDetail(sake.id);
                
                // 画像がない場合のプレースホルダ
                const imgSrc = sake.image || 'data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3e%3crect width="100" height="100" fill="%23eee"/%3e%3ctext x="50" y="50" font-family="serif" font-size="40" fill="%23ccc" text-anchor="middle" dy=".3em"%3e酒\uD83C\uDF76\uFE0E%3c/text%3e%3c/svg%3e';

                // 特定名称があればバッジ表示
                const classBadge = sake.specificClass ? `<span class="badge">${sake.specificClass}</span>` : '';

                card.innerHTML = `
                    <img src="${imgSrc}" class="sake-thumb">
                    <div class="sake-info">
                        <h3>${sake.name}</h3>
                        <p>${classBadge}${sake.maker} / ${sake.pref}</p>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }
    }

    // 画面切り替え
    function showEdit(id = null) {
        document.getElementById('page-list').classList.add('hidden');
        document.getElementById('page-edit').classList.remove('hidden');
        document.querySelector('.fab').classList.add('hidden');
        document.getElementById('header-left').innerHTML = '<div class="header-btn" onclick="goHome()">キャンセル</div>';
        document.getElementById('header-right').innerHTML = '';
        
        // フォームリセット
        document.getElementById('f-name').value = '';
        document.getElementById('f-maker').value = '';
        document.getElementById('f-pref').value = '';
        document.getElementById('f-class').value = ''; // 特定名称リセット
        document.getElementById('f-memo').value = '';
        document.getElementById('f-smv').value = 0;
        document.getElementById('smv-val').innerText = 0;
        document.getElementById('f-image').value = '';
        document.getElementById('f-image-preview').style.display = 'none';
        document.getElementById('btn-delete').classList.add('hidden');
        
        // パラメータリセット
        ['kaori','kire','koku','sanmi','amami','kuju'].forEach(k => {
            document.getElementById('p-'+k).value = 3;
        });

        // タグリセット
        document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));

        // 編集モードの場合のデータセット
        if (id) {
            currentId = id;
            const sake = sakeList.find(s => s.id === id);
            if (sake) {
                document.getElementById('f-name').value = sake.name;
                document.getElementById('f-maker').value = sake.maker;
                document.getElementById('f-pref').value = sake.pref;
                document.getElementById('f-class').value = sake.specificClass || ''; // 特定名称セット
                document.getElementById('f-memo').value = sake.memo;
                document.getElementById('f-smv').value = sake.smv;
                document.getElementById('smv-val').innerText = sake.smv;
                
                if (sake.image) {
                    const imgP = document.getElementById('f-image-preview');
                    imgP.src = sake.image;
                    imgP.style.display = 'block';
                }

                if (sake.params) {
                    ['kaori','kire','koku','sanmi','amami','kuju'].forEach(k => {
                        document.getElementById('p-'+k).value = sake.params[k] || 3;
                    });
                }
                
                // ★修正点：タグの復元処理★
                // 保存されているタグと一致するボタンをactiveにする
                if (sake.tags && Array.isArray(sake.tags)) {
                    // まず既存のタグボタンをチェック
                    document.querySelectorAll('.tag-btn').forEach(btn => {
                        if (sake.tags.includes(btn.innerText)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // ベースタグにないカスタムタグが保存されていた場合、ボタンを追加してactiveにする
                    sake.tags.forEach(tag => {
                        const existingBtn = Array.from(document.querySelectorAll('.tag-btn')).find(b => b.innerText === tag);
                        if (!existingBtn) {
                            addCustomTag(tag); // これでボタン生成＆active化
                        }
                    });
                }

                document.getElementById('btn-delete').classList.remove('hidden');
            }
        } else {
            currentId = Date.now().toString(); // 新規ID
        }
        
        window.scrollTo(0,0);
    }

    function goHome() {
        document.getElementById('page-edit').classList.add('hidden');
        document.getElementById('page-list').classList.remove('hidden');
        document.querySelector('.fab').classList.remove('hidden');
        document.getElementById('header-left').innerHTML = '';
        document.getElementById('modal-overlay').classList.remove('show');
        renderList();
    }

    // 画像プレビュー
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('f-image-preview');
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 保存処理
    async function saveSake() {
        const name = document.getElementById('f-name').value;
        if (!name) return alert('銘柄名は必須です！');

        const activeTags = [];
        document.querySelectorAll('.tag-btn.active').forEach(btn => {
            activeTags.push(btn.innerText);
        });

        const params = {};
        ['kaori','kire','koku','sanmi','amami','kuju'].forEach(k => {
            params[k] = parseInt(document.getElementById('p-'+k).value);
        });

        const newData = {
            id: currentId,
            name: name,
            maker: document.getElementById('f-maker').value,
            pref: document.getElementById('f-pref').value,
            specificClass: document.getElementById('f-class').value, // 特定名称保存
            memo: document.getElementById('f-memo').value,
            smv: document.getElementById('f-smv').value,
            tags: activeTags,
            params: params,
            updatedAt: new Date().toISOString()
        };

        // 画像処理（新規アップロードがあれば上書き、なければ既存維持）
        const imgInput = document.getElementById('f-image');
        if (imgInput.files && imgInput.files[0]) {
            const reader = new FileReader();
            reader.readAsDataURL(imgInput.files[0]);
            await new Promise(r => reader.onload = r);
            newData.image = reader.result;
        } else {
            // 既存データから画像を引き継ぐ
            const old = sakeList.find(s => s.id === currentId);
            if (old && old.image) newData.image = old.image;
        }

        // リスト更新
        const idx = sakeList.findIndex(s => s.id === currentId);
        if (idx >= 0) sakeList[idx] = newData;
        else sakeList.push(newData);

        await localforage.setItem('ak_sake_list', sakeList);
        goHome();
    }

    async function deleteSake() {
        if(!confirm('本当に削除しますか？')) return;
        sakeList = sakeList.filter(s => s.id !== currentId);
        await localforage.setItem('ak_sake_list', sakeList);
        goHome();
    }

    // 詳細表示
    function showDetail(id) {
        currentId = id;
        const sake = sakeList.find(s => s.id === id);
        if (!sake) return;

        document.getElementById('m-name').innerText = sake.name;
        document.getElementById('m-sub').innerText = `${sake.maker} / ${sake.pref}`;
        document.getElementById('m-img').src = sake.image || '';
        document.getElementById('m-img').style.display = sake.image ? 'block' : 'none';
        
        // 特定名称の表示
        const classEl = document.getElementById('m-class-badge');
        if (sake.specificClass) {
            classEl.innerText = sake.specificClass;
            classEl.style.display = 'inline-block';
        } else {
            classEl.style.display = 'none';
        }

        document.getElementById('m-memo').innerText = sake.memo;
        document.getElementById('m-smv').innerText = sake.smv > 0 ? `+${sake.smv} (甘口)` : `${sake.smv} (辛口)`;
        if(sake.smv == 0) document.getElementById('m-smv').innerText = "0 (中口)";

        // タグ表示
        const tagBox = document.getElementById('m-tags');
        tagBox.innerHTML = '';
        if(sake.tags) {
            sake.tags.forEach(t => {
                const sp = document.createElement('span');
                sp.className = 'badge';
                sp.style.background = '#ddd';
                sp.style.color = '#333';
                sp.innerText = t;
                tagBox.appendChild(sp);
            });
        }

        // チャート描画
        const ctx = document.getElementById('detailChart');
        if (myChart) myChart.destroy();
        
        const p = sake.params || {kaori:3, kire:3, koku:3, sanmi:3, amami:3, kuju:3};
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['香り', 'キレ', 'コク', '酸味', '甘味', '苦渋'],
                datasets: [{
                    label: '味わい',
                    data: [p.kaori, p.kire, p.koku, p.sanmi, p.amami, p.kuju],
                    backgroundColor: 'rgba(212, 175, 55, 0.2)',
                    borderColor: '#d4af37',
                    borderWidth: 2,
                    pointBackgroundColor: '#d4af37'
                }]
            },
            options: {
                scales: {
                    r: {
                        min: 0, max: 5,
                        ticks: { stepSize: 1, display: false },
                        pointLabels: { font: { size: 12 } }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        document.getElementById('modal-overlay').classList.add('show');
    }

    function closeModal(e) {
        if (e.target.id === 'modal-overlay') {
            document.getElementById('modal-overlay').classList.remove('show');
        }
    }
    
    function closeModalDirect() {
        document.getElementById('modal-overlay').classList.remove('show');
    }

    function editCurrentSake() {
        showEdit(currentId);
    }
</script>
</body>
</html>
